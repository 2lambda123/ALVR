<!DOCTYPE html>
<html>

<head>
    <title>ALVR Launcher</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h3 id="title">
                    ALVR is loading...
                </h3>
                <div id="ready" style="display:none">
                    <p>Waiting for driver to load...</p>
                    <button id="restart-btn" class="btn btn-primary" style="display:none">Restart SteamVR</dibutton>
                </div>
                <div id="updating" style="display:none">
                    <p>Updating... Please wait...</p>
                </div>
                <div id="not-ready" style="display:none">
                    <div>
                        SteamVR
                        <span id="steamvr-check"></span>
                    </div>
                    <div>
                        <a href="https://aka.ms/vs/16/release/vc_redist.x64.exe">
                            Visual C++ Redistributable package x64
                        </a>
                        <span id="msvcp-check"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function resizeAndCenter(width, height) {
            window.resizeTo(width, height);
            var locationX = (screen.availWidth - window.outerWidth) / 2;
            var locationY = (screen.availHeight - window.outerHeight) / 2;
            window.moveTo(locationX, locationY);
        }
        resizeAndCenter(500, 300);

        function pingWebServer() {
            return new Promise(resolve => {
                xhttp = new XMLHttpRequest();
                xhttp.open("GET", "http://127.0.0.1:8082");
                xhttp.onreadystatechange = function () {
                    if (xhttp.readyState == XMLHttpRequest.DONE) {
                        if (xhttp.status == 200) {
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    }
                }
                xhttp.send();
            });
        }

        async function checkInstallation() {
            let steamvrInstalled = await checkSteamvrInstallation();
            let msvcpInstalled = await checkMsvcpInstallation();

            if (steamvrInstalled && msvcpInstalled) {
                document.getElementById("not-ready").style.display = "none";
                document.getElementById("ready").style.display = "block";
                document.getElementById("updating").style.display = "none";
                document.getElementById("title").innerHTML = "ALVR is loading...";

                return true;
            } else {
                if (steamvrInstalled) {
                    document.getElementById("steamvr-check").innerText = "[Installed]";
                } else {
                    document.getElementById("steamvr-check").innerText =
                        "[Not installed] Check that you ran it at least once, then close it";
                }
                if (msvcpInstalled) {
                    document.getElementById("msvcp-check").innerText = "[Installed]";
                } else {
                    document.getElementById("msvcp-check").innerText = "[Not installed]";
                }

                document.getElementById("not-ready").style.display = "block";
                document.getElementById("ready").style.display = "none";
                document.getElementById("title").innerHTML = "Installation";
                document.getElementById("updating").style.display = "none";

                return false;
            }
        }
        function promptUpdate() {
            var update = confirm("Update found! Would you like to update?");
            if (update) {
                document.getElementById("updating").style.display = "block";
            }
            return update;
            
        }

        function init() {
            document.getElementById("restart-btn").onclick = function () {
                (async () => {
                    await restartSteamvr();
                })();
            };

            (async () => {
                while (!await checkInstallation()) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                (async () => {
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    document.getElementById("restart-btn").style.display = "block";
                })();

                await startDriver();

                while (!await pingWebServer()) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    console.log("retry ping...");
                }

                resizeAndCenter(800, 600);
                window.location.assign("http://127.0.0.1:8082");
            })()
        }

    </script>
</body>

</html>